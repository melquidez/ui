#!/bin/bash

# Dependencies:
# - mercurial
# - git
# - vim

# The command to rollback a git submodule is NOT `git checkout` as it is for
# normal files, but rather you have to run `git reset --hard HEAD@{1}` from the
# directory of the submodule.
# TODO: Figure out the equivalent command for mercurial. (Think it might
# something like `hg update -r <rev-id>`.)

ROOT=~/ui
THIRD_PARTY_PACKAGES=$ROOT/vendor
EMACS_PACKAGES_DIR=$THIRD_PARTY_PACKAGES/emacs

DL_HG_PACKAGES=$ROOT/misc/dl-hg-packages
echo '#!/bin/env bash' > $DL_HG_PACKAGES
printf "Updating $(tput bold)evil:$(tput sgr0) "
cd $EMACS_PACKAGES_DIR/evil
hg pull -u
NEW_ID=$(hg --debug id -i)
ORIGIN='https://bitbucket.org/lyro/evil'
printf "cd ${EMACS_PACKAGES_DIR/$HOME/\~}\nhg clone -r ${NEW_ID} ${ORIGIN}\n" \
       >> $DL_HG_PACKAGES

cd $EMACS_PACKAGES_DIR
find . -maxdepth 1 -mindepth 1 -type d \
     -exec bash -c \
     'cd "$0"; [[ -f ".git" ]] && printf "Updating $(tput bold)${0/.\//}:$(tput sgr0) " && git pull' \
     {} \;

printf "Updating $(tput bold)vim-plug:$(tput sgr0) "
cd $THIRD_PARTY_PACKAGES/vim/vim-plug
git pull
cd $ROOT
# `norm D` to see the changes, if any.
vim +PlugUpdate +only "+norm D"
