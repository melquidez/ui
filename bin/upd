#!/bin/bash

# Dependencies:
# - git
# - mercurial
# - vim
#
# The command to rollback a git submodule is NOT `git checkout` as it is for
# normal files, but rather you have to run `git reset --hard HEAD@{1}` from the
# directory of the submodule.
#
# TODO: Figure out the equivalent command for mercurial. (Think it might
# something like `hg update -r <rev-id>`.)

root="${HOME}/ui"
third_party_packages=$root/vendor
emacs_packages_dir=$third_party_packages/emacs

append-date-line-to-log () {
  echo "=== ${1^} === $(date)" >> $root/update-log
}

update-git-packages () {
  cd "$1"
  append-date-line-to-log "$(basename ${1})"
  find . -maxdepth 1 -mindepth 1 -type d -exec bash -c \
       'cd "$0"; [[ -f ".git" ]] && git pull &' {} \; | tee -a $root/update-log
  cd $root
}

dl_hg_packages=$root/misc/dl-hg-packages
cd $emacs_packages_dir/evil
append-date-line-to-log evil
hg pull -u | tee -a $root/update-log
new_id=$(hg --debug id -i)
origin='https://bitbucket.org/lyro/evil'
echo '#!/bin/bash' > $dl_hg_packages
printf "cd ${emacs_packages_dir/$HOME/\~}\nhg clone -r ${new_id} ${origin}\n" \
       >> $dl_hg_packages
cd $root

for dir in $third_party_packages/*/; do
  update-git-packages "${dir}"
done

vim -S ./misc/update-vim-plugins.vim
