#!/usr/bin/guile \
-e main -s
!#

(define home (getenv "HOME"))
(define editor (getenv "EDITOR"))

(define (home-path path)
  (string-append home "/" path))

(define (edit . files)
  (system (string-append editor " " (string-join files))))

(define (mkdir-p dir)
  (unless (file-exists? dir)
    (mkdir dir)))

(define (enter-dir dir)
  (mkdir-p dir)
  (chdir dir))

(define (download-stage root pid)
  (string-append root "/tmp" (number->string pid)))

(define (find-download-stage root)
  (mkdir-p root)
  (let ((pid 1))
    (while (file-exists? (download-stage root pid))
      (set! pid (1+ pid)))
    (download-stage root pid)))

(define (main args)
  (let ((download-location (home-path "dl/music"))
        (mpd-pid (home-path ".config/mpd/pid"))
        (music-store (home-path "music"))
        (playlists-location (home-path ".config/mpd/playlists")))
    (enter-dir (find-download-stage download-location))
    (call-with-output-file "playlists"
      (lambda (out)
        (display "hi" out)
        (newline out)))))
